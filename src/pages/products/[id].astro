---
import Base from "@/layouts/Base.astro";
import { Clients } from "../../components/Clients";
import { AdditionalFeatures } from "../../components/common/AdditionalFeatures";
import NewFAQ from "../../components/NewFAQ";
import { FeaturesGrid } from "../../components/common/FeaturesGrid";
import { FeatureShowcase } from "../../components/common/FeatureShowcase";
import { MobileFeatures } from "../../components/common/MobileFeatures";
import { ProductHeader } from "../../components/common/ProductHeader";
import SFACTA from "../../components/sfa/SFACTA";
import LECTA from "../../components/loyalty/LECTA";
import { sanityClient } from "sanity:client";

interface Product {
  id: string;
  title: string;
  metaTitle: string;
  metaDescription: string;
  headerContent: any;
  featuresGridSection: any;
  mobileFeaturesSection: any;
  featureShowcaseSection: any;
  additionalFeaturesSection: any;
  faqSection: any;
  ctaSection: any;
}

export async function getStaticPaths() {
  const productsQuery = `
    *[_type == "dynamicProductPage"] {
      "id": slug.current,
      title,
      metaTitle,
      metaDescription,
      headerContent,
      featuresGridSection,
      mobileFeaturesSection,
      featureShowcaseSection,
      additionalFeaturesSection,
      faqSection,
      ctaSection
    }
  `;
  
  try {
    const products = await sanityClient.fetch(productsQuery);
    
    return products.map((product: {id: string}) => {
      return {
        params: { id: product.id },
        props: { product },
      };
    });
  } catch (error) {
    console.error("Error fetching products:", error);
    return [];
  }
}

// Add type annotation to props destructuring
const { product } = Astro.props as { product: Product };

if (!product) {
  return Astro.redirect('/404');
}

// Determine which CTA component to use based on product ID
const CTAComponent = product.id === "sfa-test" ? SFACTA : LECTA;

---

<Base
  title={product.title}
  meta_title={product.metaTitle}
  description={product.metaDescription}
>
  <ProductHeader {...product.headerContent} client:load />
  <Clients client:load />
  <FeaturesGrid 
    client:load 
    features={product.featuresGridSection.features} 
    heading={product.featuresGridSection.heading} 
  />
  <MobileFeatures 
    client:load 
    mobileFeatures={product.mobileFeaturesSection} 
  />
  <FeatureShowcase 
    variant={product.id as "sfa" | "loyalty"} 
    showcaseContent={product.featureShowcaseSection} 
    client:load 
  />
  <AdditionalFeatures 
    client:load 
    additionalFeatures={{
      heading: product.additionalFeaturesSection.heading,
      features: product.additionalFeaturesSection.features
    }} 
  />
  <NewFAQ client:load Faq={[product.faqSection]} />
  <!-- // <CTAComponent client:load ctaContent={product.ctaSection} /> -->
</Base>
